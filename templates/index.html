{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Elastic TEST</title>

    <script src="{% static 'js/jquery-3.6.0.min.js' %}?ver={% now "U" %}"></script>

    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

    <script src="//cdn.jsdelivr.net/npm/sweetalert2@10"></script>

    <link href="{% static 'css/my_css.css' %}?ver={% now "U" %}" rel="stylesheet" type="text/css"/>
    <script src="{% static 'js/my_js.js' %}?ver={% now "U" %}"></script>
</head>
<body>
<div>
    <p class="m-0 text-center"><b id="page-title">Elasticsearch에 JSON 저장시키기</b></p>
</div>
<hr class="m-0">
<div class="flex-container">
    <div id="content">
        <label><b>1. Enter the IP address and port of Elasticsearch.</b></label>
        <div class="input-group ml-4 mb-2 w-404px">
            <div class="row ml-0 mr-0 w-100">
                <div class="col-9 p-0">
                    <input type="text" class="form-control" id="es-ip" placeholder="127.0.0.1"
                           minlength="7" maxlength="15" size="15"
                           oninput="this.value = this.value.replace(/[^0-9,.]/g, '');">
                </div>
                <div class="col p-0 pl-1">
                    <input type="text" class="form-control" id="es-port" placeholder="9200"
                           maxlength="5"
                           oninput="this.value = this.value.replace(/[^0-9]/g, '');">
                </div>
            </div>
        </div>
        <label><b>2. Select JSON file.</b></label>
        <div class="input-group ml-4 mb-2 w-404px">
            <div class="custom-file">
                <input type="file" class="custom-file-input" id="file" accept=".json">
                <label class="custom-file-label" for="file"></label>
            </div>
        </div>
        <label><b>3. Enter a prefix for the index name.</b></label>
        <div class="input-group ml-4 mb-2 w-404px">
            <input type="text" class="form-control" id="index-prefix">
        </div>
        <div class="input-group ml-4 mb-2 w-404px mt-4 d-flex flex-row-reverse">
            <button id="save-btn" type="button" class="btn btn-primary"><b>SAVE</b></button>
        </div>
    </div>
</div>
<script>

    let objects_extracted_from_json = null;

    // json 파일만 입력 가능하게... 추후 csv 추가.
    function check_fileType() {
        const file_value = $("#file").val().split("\\")
        const file_full_name = file_value[file_value.length - 1];
        const fileFormat = file_full_name.split(".");
        if (fileFormat.indexOf("json") > -1) {
            return true;
        } else {
            return false;
        }
    }

    // IP 입력란에 입력한 텍스트가 IP 형식인지 검사.
    function ValidateIPaddress(inputText) {
        var ipformat = /^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/;
        if (ipformat.test(inputText)) {
            return true;
        } else {
            return false;
        }
    }

    $('#save-btn').on('click', () => {
        let es_ip = $('#es-ip').val();
        let es_port = $('#es-port').val();
        const file_name = $('#file').val().replace('C:\\fakepath\\', '');
        const index_prefix = $('#index-prefix').val();

        // 예외처리
        if (es_ip === '') {
            es_ip = '127.0.0.1';
        } else {
            if (!ValidateIPaddress(es_ip)) {
                alert('IP 주소 형식을 지켜서 입력해주세요.');
                return;
            }
        }

        if (es_port === '') {
            es_port = '9200';
        }

        if (file_name.trim() === '') {
            alert('파일을 첨부하세요.');
            return;
        } else if (index_prefix.trim() === '') {
            alert('Index의 prefix를 입력하세요.');
            return;
        } else {
            const file = $("#file")[0].files[0];
            const formData = new FormData();
            formData.append("file", file);
            formData.append("index_prefix", index_prefix);
            formData.append("es_ip", es_ip);
            formData.append("es_port", es_port);
            $.ajax({
                    url: "{% url 'common:save_the_data_in_elastic' %}",
                    type: "POST",
                    processData: false,
                    contentType: false,
                    data: formData,
                    beforeSend: function () {
                        Swal.fire({
                            html: '<b>엘라스틱에 데이터 저장 중</b>',
                            allowOutsideClick: false,
                            showConfirmButton: false,
                            width: 350,
                            onBeforeOpen: () => {
                                Swal.showLoading();
                            },
                        });
                    },
                    success: function (data) {
                        if (data.result === true) {
                            Swal.fire({
                                title: '저장 성공',
                                icon: 'success',
                                allowOutsideClick: true,
                                showConfirmButton: true,
                                width: 350,
                            });
                        } else {
                            Swal.fire({
                                title: '저장 실패',
                                html: data.msg,
                                icon: 'error',
                                allowOutsideClick: true,
                                showConfirmButton: true,
                                width: 350,
                            });
                        }
                    }
                }
            );
        }
    })

    $('#file').on('change', function () {
        if (!check_fileType()) {
            alert('json 파일만 입력가능합니다.');
            $("#file").val("");
            $('.custom-file-label').html('');
            objects_extracted_from_json = null;
            return;
        } else {
            const file_full_name = $(this).val();
            $('.custom-file-label').html(file_full_name.replace('C:\\fakepath\\', ''));

            const file = $("#file")[0].files[0];
            const formData = new FormData();
            formData.append("file", file);
            $.ajax({
                    url: "{% url 'common:detect_list_in_json' %}",
                    type: "POST",
                    processData: false,
                    contentType: false,
                    data: formData,
                    beforeSend: function () {

                    },
                    success: function (data) {
                        if (data.result === true) {
                            objects_extracted_from_json = data.lists
                            Toast.fire({
                                icon: 'success',
                                title: data.msg
                            })
                        } else {
                            objects_extracted_from_json = null;
                            Toast.fire({
                                icon: 'error',
                                title: data.msg
                            })
                        }
                    }
                }
            );
        }
    })

    const Toast = Swal.mixin({
        toast: true,
        position: 'bottom-end',
        showConfirmButton: true,
        timer: 3000,
        padding: 20,
        timerProgressBar: true,
        didOpen: (toast) => {
            toast.addEventListener('mouseenter', Swal.stopTimer)
            toast.addEventListener('mouseleave', Swal.resumeTimer)
        }
    })
</script>
</body>
</html>